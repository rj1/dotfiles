#!/bin/sh
    
ROFI="rofi -dmenu -input /dev/null -password -lines 0"
DESC=""
ERROR=""
PROMPT=""

echo "OK Please go ahead"
while read cmd rest; do

    if [ -z "$cmd" ]; then
        continue;
    fi

    case "$cmd" in
        \#*)
            echo "OK"
            ;;

        GETINFO)
            case "$rest" in
                flavor)
                    echo "D rofi"
                    echo "OK"
                    ;;
                version)
                    echo "D 0.1"
                    echo "OK"
                    ;;
                ttyinfo)
                    echo "D - - -"
                    echo "OK"
                    ;;
                pid)
                    echo "D $$"
                    echo "OK"
                    ;;
            esac
            ;;

        SETDESC)
            DESC=$rest
            echo "OK"
            ;;

        SETERROR)
            ERROR=$( echo _ERO_${rest}_ERC_ | awk '{print toupper($0)}')
            echo "OK"
            ;;

        SETPROMPT)
            PROMPT=$(echo $rest | tr -d ':')
            echo "OK"
            ;;

        GETPIN)
            # this shit right here is to deal with some pango markup related
            # bullshit. i don't underestand why there isn't an option to turn
            # pango in rofi. anyway, this adds some markup for flavor and
            # corrects the output so that rofi doesn't complain about the input
            # it receives. there must be a better way to get newlines in the
            # prompt. oh well.
            MESSAGE=$( echo "$ERROR$DESC" | sed -e "s|%0A||g"                \
                                    -e "s|%22||g"                            \
                                    -e "s|key:|key:\n|g"                     \
                                    -e "s|>|>\n|g"                           \
                                    -e "s|<|\&lt;|g"                         \
                                    -e "s|>|\&gt;|g"                         \
                                    -e "s|,created|,\ncreated|g"             \
                                    -e "s|_ERO_|<span fgcolor='#ab4642'>|g"  \
                                    -e "s|_ERC_|</span>\n|g"                 )

            # display the gpg messages as lowercase for absolutely no reason :)
            MESSAGE=$( echo $MESSAGE | tr '[:upper:]' '[:lower:]')

            rofi_cmd="$ROFI -p \"password: \" -mesg \"$MESSAGE\""
            _PP=$( $ROFI -p "password: " -mesg "$MESSAGE" )

            if [ -n "$_PP" ]; then
                echo "D $_PP"
            fi
            echo "OK"
            ;;

        BYE)
            #echo "BYE, exiting" >>/tmp/pinentry-rofi.log
            echo "OK closing connection"
            exit 0
            ;;

        *)
            echo "OK"
            ;;
    esac
done
